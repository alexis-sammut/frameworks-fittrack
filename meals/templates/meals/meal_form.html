{% extends "base.html" %} 

{% block main %}
<section id="log-meal" class="section">
  <div class="container">
    <h2>{% if is_update %}Update{% else %}Log{% endif %} Your Meal</h2>
    
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
    
    <form
      class="data-form"
      id="mealForm"
      action="{% if is_update %}{% url 'meal-update' meal.pk %}{% else %}{% url 'log-meal' %}{% endif %}"
      method="POST"
    >
      {% csrf_token %}
      <input type="hidden" name="mealData" id="mealData" />
      
      <div id="foodEntriesContainer">
        <div class="form-entry-row">
          <div class="form-group">
            <label for="meal-name">Meal Name</label>
            <input
              type="text"
              id="meal-name"
              name="meal-name"
              placeholder="e.g, Lunch"
              value="{% if is_update %}{{ meal.name }}{% endif %}"
              required
            />
            <label for="foodName1">Food Name</label>
            <input
              type="text"
              id="foodName1"
              name="foodName[]"
              placeholder="e.g., Chicken Breast"
              required
            />
          </div>
          <div class="form-group form-secondary-group">
            <label for="foodQuantity1">Quantity (g)</label>
            <input
              type="number"
              id="foodQuantity1"
              name="foodQuantity[]"
              placeholder="100"
              min="1"
            />
          </div>
        </div>
      </div>
      
      <p id="addFieldError"></p>
      <button type="button" class="add-item-button" id="addFoodItemBtn">+</button>
      
      <div class="nutrition-results">
        <div class="nutrition-details"></div>
      </div>

      <div class="form-group">
        <button type="button" id="getNutritionButton" class="button secondary-button">
          Get Nutritional Data
        </button>
        <button type="button" id="resetForm" class="button secondary-button">
          Reset Form
        </button>
        <div id="loader" class="spinner"></div>
        
        <div id="nutritionTableContainer" class="table-responsive-container" {% if not is_update %}style="display: none;"{% endif %}>
          <h3>Nutrition Summary</h3>
          <table class="nutrition-table">
            <thead>
              <tr>
                <th scope="col">Nutrient</th>
                <th scope="col">Amount (g)</th>
                <th scope="col">Fat Total (g)</th>
                <th scope="col">Saturated Fat (g)</th>
                <th scope="col">Carbohydrates Total (g)</th>
                <th scope="col">Fiber (g)</th>
                <th scope="col">Sugar (g)</th>
                <th scope="col">Sodium (mg)</th>
                <th scope="col">Potassium (mg)</th>
                <th scope="col">Cholesterol (mg)</th>
              </tr>
            </thead>
            <tbody id="nutritionTable">
              <!-- Data will be populated here by JavaScript -->
            </tbody>
          </table>
        </div>
        
        <button
          id="logMealButton"
          type="submit"
          class="button"
          {% if not is_update %}style="display: none"{% endif %}
        >
          {% if is_update %}Update{% else %}Log{% endif %} Meal
        </button>
      </div>
    </form>
    
    {% if is_update %}
    <a href="{% url 'meal-detail' meal.pk %}" class="button secondary-button">Cancel</a>
    {% endif %}
  </div>
</section>

{% if is_update %}
<script>
  // Pass the ingredients data to JavaScript
  window.existingIngredientsData = {{ ingredients_json|safe }};
  window.isUpdateMode = true;
</script>
{% endif %}

{% endblock %}